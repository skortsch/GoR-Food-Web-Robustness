###SEM modeling GoR food web###

#working dir
setwd("C:/LocalData/susakort/SEM_model/RscriptsBauer2022")

#R packages
library("igraph")
library("fluxweb")
library(tidyverse)
library(lavaan)
library(mice)
library(lavaanPlot)
library (vegan)


#import environmental data
env.gor<-read.csv("GoR_Env_MFA.csv", sep="")

#Fisheries
fisheries<-as_tibble(env.gor) %>% select(Her.GoR.Catches, Spr.BS.Catch)

#GoR food web info
info_GoR<-load("BalticFW.RData")
str(info_GoR)
info

#### PREPARING THE FOOD WEB DATA ###
#weighted food webs
#w_fw<-readRDS("weighted_foodwebs.rds")
#unweighted food webs
#uw_fw<-readRDS("unweighted_foodwebs.rds")
#unweighted meta web
#load("BalticFW.RData")
#uw_mw_el<-net
#Weighted Metaweb
#biomass <- info$meanB
#netmatrix <- get.adjacency(net, sparse=F)
#fluxes <- fluxing(netmatrix, biomass, info$losses, info$efficiencies, ef.level="prey")
#fluxes <- fluxes*86.4 #weighted network
#W_Mweb.el<- graph_from_adjacency_matrix(fluxes, weighted=TRUE)
#w_mw_el<- graph_from_adjacency_matrix(fluxes, weighted=TRUE)
#write.csv(fluxes, "weighted_metaweb_GoR.csv", row.names = F)
#w_mw<-read.csv("weighted_metaweb_GoR.csv", check.names = FALSE)
#rownames(w_mw)<-colnames(w_mw)
#un_mw<-1*(w_mw>0)
#write.csv(un_mw, "unweighted_metaweb_GoR.csv", row.names = F)
#MAKE RDATA FILE OF ALL FOOD WEBS
#save(w_mw, un_mw, uw_mw_el, w_mw_el,file = "metawebs_GoR.RData") 
######################################

#load Food web data
load("metawebs_GoR.RData")
load("uw_fw_GoR.RData")
load("w_fw_GoR.RData")

#Selected years
years.sel<-c(1981, 1986, 1991, 1996, 2001, 2006, 2011)


#Species dissimilarities are calculated as Jaccard dissimilarities between years based on their species compositions (presence-absence) 
#the jaccard dist ranges between 0 and 1, if two samples are equal = 1
#biomass
biomass.dat<-read.csv("biom_GoR_years_sel.csv", sep=";", header=TRUE, check.names = FALSE, row.names = 1)
bm<-t(biomass.dat)
sp.pa<-1*(bm>0)
#presence/absence distance
sp.dist.pa<-1-vegdist(sp.pa, method="jaccard", binary=TRUE)
#biomass distance
sp.dist.bm<-1-vegdist(bm, method="jaccard")

#convert distance matrix into a data table
xy <- t(combn(colnames(as.matrix(sp.dist.pa)), 2))
sp.pa.dist<-data.frame(xy, sp.pa=as.matrix(sp.dist.pa)[xy])

xy.bm <- t(combn(colnames(as.matrix(sp.dist.bm)), 2))
sp.bm.dist<-data.frame(xy.bm, sp.bm=as.matrix(sp.dist.bm)[xy])

dist<-cbind(sp.pa.dist, sp.bm=sp.bm.dist[,3])
colnames(dist)<-c("Year.1", "Year.2", "sp.pa", "sp.bm")
dist <- dist[ , c("Year.2", "Year.1", "sp.pa", "sp.bm")] #change order of two first columns

dist <- dist %>% mutate(environmental = NA, foodweb = NA, fisheries = NA, traits=NA)  

#betadiversity
#https://rdrr.io/rforge/vegan/src/R/nestedbetasor.R
#m <- betadiver(sp.pa)
#plot(m)
#m <- betadiver(bm)
#plot(m)
#nestedbetajac(sp.pa)


#Environmental data
names(env.gor)
env.gor.sel<-as_tibble(env.gor) %>% select("Year", "B.Temperature", "B.Salinity", "B.Phosphate", "B.Oxygen", "Sum_discharge") %>% 
  #gather(key="Env.var", value="Value", "B.Temperature", "B.Salinity", "B.Phosphate", "B.Oxygen", "Sum_discharge") %>% 
  filter(Year%in%years.sel)

env.gor.sel<-as.data.frame(env.gor.sel)
#PCA on environmental data
rownames(env.gor.sel) <- env.gor.sel[,1]
pca.env <- prcomp(env.gor.sel[,-1], scale=TRUE)

plot(cumsum(pca.env$sdev^2 / sum(pca.env$sdev^2)), type="b")
abline(h=0.75)
pca.env <- pca.env$x[, c(1:2)]

# fill in Euclidean dist for the env data
for(i in 1:nrow(dist)){
  #i<-1
  Year.1 <- as.character(dist[i, "Year.1"])
  Year.2 <- as.character(dist[i, "Year.2"])
  dist$environmental[i] <- sqrt(sum((as.numeric(pca.env[Year.1, ]-pca.env[Year.2, ]))^2))
}


#calculate for selected food web properties for the different years
#PCA distances of the food web properties

#differences in trait dispersion among years #most challenging for me right now

#Calculate distances for the flux data for the different years



